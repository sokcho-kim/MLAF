# 🏛️ 의안(Bill) 데이터 플로우 종합 분석

## 📊 전체 아키텍처(21,22 대 데이터 수집)

```markdown
┌───────────────────────────────────────────────────────────────────────────┐
│                        BILL DATA PIPELINE ARCHITECTURE                     │
└───────────────────────────────────────────────────────────────────────────┘

 [Sources]
   ┌──────────────────────────────────────┐      ┌──────────────────────────────┐
   │ 열린국회정보 (open.assembly.go.kr)   │      │ 공공데이터포털 (api.odcloud.kr)│
   │  - nzmimeepazxkubdpn (의원발의)      │      │  - getBillInfoList (요약)      │
   │  - ALLBILL (전체 의안)               │      │  - getBillReceiptInfo (첨부)   │
   │  - BILLINFOPPSR (제안자)             │      │  - getBillCommission... (심사) │
   │  - BILLJUDGECONF (위원회, SECONDARY) │      └───────────────┬──────────────┘
   │  - BILLLWJUDGECONF (법사위, SECONDARY)│                     │
   │  - ncocpgfiaoituanbr (표결)          │                      │
   │  - TVBPMBILL11 (검색, 정부/위원장)   │                      │
   │  - BILLINFODETAIL (공포)             │                      │
   └───────────────────────┬──────────────┘                      │
                           └───────────────┬─────────────────────┘
                                           ▼

┌───────────────────────────────────────────────────────────────────────────┐
│ PHASE 1–6  COLLECTION (수집)                                               │
│   - src/domains/assembly/bill/collect.py                                   │
│   - scripts/batch/run_phase_4_6_noprefect.py                                │
└───────────────────────────────────────────────────────────────────────────┘
                                           ▼
┌───────────────────────────────────────────────────────────────────────────┐
│ ods_raw (Raw Layer) : 원본 JSON 보존                                       │
│   raw_bill                    (40,374)  의원발의 원안                       │
│   openasm_bill_master_json    (41,367)  전체 의안 마스터                    │
│   openasm_bill_proposer_json (485,659)  제안자 정보                         │
│   openasm_bill_vote_json       (1,056)  본회의 표결                         │
│   openasm_bill_cmte_exam_json(283,427)  위원회 심사                         │
│   godata_bill_info_json       (42,666)  의안 요약                           │
│   scrape_bill_content_json    (47,924)  HWP/PDF 텍스트                      │
└───────────────────────────────────────────────────────────────────────────┘
                                           ▼
┌───────────────────────────────────────────────────────────────────────────┐
│ PHASE 7–10 TRANSFORMATION (변환)                                           │
│   - src/domains/assembly/bill/transform.py                                 │
│   - scripts/batch/run_bill_phase_2_transform.py                            │
└───────────────────────────────────────────────────────────────────────────┘
                                           ▼
┌───────────────────────────────────────────────────────────────────────────┐
│ ods_core (Core Layer) : 정규화 엔티티                                      │
│   bill                (41,367)  의안 마스터                                 │
│   bill_stage          (46,706)  진행 단계 (SCD Type 2)                      │
│   bill_committee     (283,427)  소관위/법사위 심사                          │
│   bill_vote            (3,888)  표결 결과                                   │
│   bill_member        (485,659)  제안자/공동발의자/투표자                    │
│   bill_promulgation   (41,367)  공포 정보                                   │
│   bill_summary        (41,252)  제안이유/주요내용                           │
│   artifact            (95,685)  첨부파일 메타데이터                          │
│   bill_content        (47,924)  추출 텍스트 (Phase 12)                      │
│   bill_table         (311,038)  추출 테이블 (Phase 15)                      │
│   bill_law_diff      (292,300)  신구조문대비표                              │
│   bill_cost_estimate (314,973)  비용추계서                                  │
└───────────────────────────────────────────────────────────────────────────┘
                                           ▼
┌───────────────────────────────────────────────────────────────────────────┐
│ PHASE 11  DM BUILD & INDEXING (분석 레이어)                                 │
│   - src/domains/assembly/bill/index.py                                     │
└───────────────────────────────────────────────────────────────────────────┘
                                           ▼
┌───────────────────────────────────────────────────────────────────────────┐
│ dm (Data Mart) : 비정규화 검색/분석 최적화                                 │
│   bill_search        (41,367)  OpenSearch 동기화용                          │
│   bill_change_log              변경 감지/알림                               │
│   v_bill_analytics             집계 뷰                                      │
└───────────────────────────────────────────────────────────────────────────┘
                                           ▼
┌───────────────────────────────────────────────────────────────────────────┐
│ PHASE 12–14  ML EMBEDDING (벡터화)                                         │
│   - run_bill_phase_12_embedding.py (실시간)                                  │
│   - run_bill_phase_12_embedding_batch.py (배치 API, 50% 절감)                │
└───────────────────────────────────────────────────────────────────────────┘
                                           ▼
┌───────────────────────────────────────────────────────────────────────────┐
│ ml (ML Layer) : pgvector 기반 벡터 저장                                     │
│   embedding_bill (1536d)                                                   │
│     - title_embedding    (41,341) 100% ✅                                   │
│     - summary_embedding   (1,300)   3% ⏳                                   │
│     - full_text_embedding     (5)  <1% ⏳                                   │
│   feature_bill     (ML 피처)                                                │
│   label_bill       (학습 레이블)                                            │
│   bill_similarity  (유사도 매트릭스)                                        │
└───────────────────────────────────────────────────────────────────────────┘

```

---

## 📁 핵심 파일 위치

| 레이어 | 파일 | 설명 |
| --- | --- | --- |
| **수집** | collect.py | API 호출 및 원본 저장 |
| **변환** | transform.py | Raw → Core 변환 로직 |
| **인덱싱** | index.py | Core → DM 비정규화 |
| **스키마** | 03_ods_raw_tables.sql | Raw 테이블 DDL |
| **스키마** | 04_ods_core_bill.sql | Core 테이블 DDL |
| **스키마** | 06b_ml_bill.sql | ML 테이블 DDL |
| **문서** | BILL_STATUS.md | 운영 현황 |

---

## 🔄 데이터 흐름 단계별 설명

### **Phase 1-6: 수집 (Collection)**

- **열린국회정보 API**: 의안 기본정보, 제안자, 위원회, 표결
- **공공데이터포털 API**: 요약, 첨부파일 URL
- **저장**: `ods_raw` 스키마에 JSONB 원본 보존

### **Phase 7-10: 변환 (Transformation)**

- **정규화**: Raw JSON → 관계형 테이블
- **변경 감지**: 해시 비교로 증분 업데이트
- **관계 설정**: bill_id FK로 연결

### **Phase 11-15: 콘텐츠 추출**

- **Phase 11**: HWP/PDF 파일 다운로드 (95,685건)
- **Phase 12**: 텍스트 추출 (47,924건)
- **Phase 14**: 텍스트 정제 (95,657건)
- **Phase 15**: 테이블 파싱 (신구조문 292K + 비용추계 315K)

### **Phase 12 ML: 임베딩**

- **모델**: Google Gemini `gemini-embedding-001` (1536차원)
- **Batch API**: 50% 비용 절감 ($0.075/1M 토큰)
- **현황**: title 100% ✅, summary/full_text 진행 중

---

## 📊 현재 상태 요약

| 지표 | 값 |
| --- | --- |
| **총 의안 수** | 41,367건 |
| **제안자 기록** | 485,659건 |
| **위원회 심사** | 283,427건 |
| **텍스트 추출** | 47,924건 (Phase 12) |
| **신구조문대비** | 292,300건 (Phase 15B) |
| **비용추계** | 314,973건 (Phase 15C) |