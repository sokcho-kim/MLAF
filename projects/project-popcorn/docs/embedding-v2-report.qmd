---
title: "임베딩 v2 테스트 결과"
subtitle: "제목 vs 제목+제안이유 비교 분석"
author: "MLAF Project"
date: "2026-01-16"
format:
  html:
    toc: true
    toc-depth: 3
    code-fold: true
    theme: cosmo
execute:
  echo: true
  warning: false
---

## 개요

### 실험 목적

**"산업통상자원부 입법 리스크 레이더"**가 Cross-Domain 법안을 얼마나 잘 감지하는지 측정하기 위한 임베딩 비교 테스트입니다.

- **v1**: 법안 제목만 임베딩
- **v2**: 법안 제목 + 제안이유(summary) 임베딩

### 가설

> 제안이유(summary)를 포함하면, 제목만으로는 파악하기 어려운 **Cross-Domain 관련성**을 더 잘 감지할 수 있을 것이다.

---

## 데이터

```{python}
import json
import pandas as pd
import matplotlib.pyplot as plt
import matplotlib.font_manager as fm
import numpy as np
from pathlib import Path

# 한글 폰트 설정
plt.rcParams['font.family'] = 'Malgun Gothic'
plt.rcParams['axes.unicode_minus'] = False

# 데이터 로드
DATA_DIR = Path('../research/results')

with open(DATA_DIR / 'embedding_v2_test.json', 'r', encoding='utf-8') as f:
    results = json.load(f)

# DataFrame 변환
solar_df = pd.DataFrame(results['solar'])
openai_df = pd.DataFrame(results['openai'])

print("테스트 일시:", results['tested_at'])
```

### Golden Set 구성

Cross-Domain 감지 테스트를 위해 선정된 5개 법안:

```{python}
# Golden Set 정보
with open('../data/golden_set_v2.json', 'r', encoding='utf-8') as f:
    golden = json.load(f)

golden_info = []
for b in golden['bills']:
    golden_info.append({
        'ID': b['golden_id'],
        '난이도': b['difficulty'],
        '법안명': b['bill_name'][:35] + '...' if len(b['bill_name']) > 35 else b['bill_name'],
        '소관위': b['committee'],
        '리스크': b['risk_description']
    })

pd.DataFrame(golden_info)
```

::: {.callout-note}
## 타겟 부처
**산업통상자원부** - 산업, 통상, 무역, 에너지 정책 담당
:::

---

## 결과

### 모델별 유사도 비교

```{python}
#| fig-cap: "v1(제목) vs v2(제목+Summary) 유사도 비교"
#| fig-width: 10
#| fig-height: 6

fig, axes = plt.subplots(1, 2, figsize=(12, 5))

# 색상 설정
colors = {'Easy': '#4CAF50', 'Medium': '#FFC107', 'Hard': '#F44336'}

# Solar Embedding
ax1 = axes[0]
x = np.arange(len(solar_df))
width = 0.35

bars1 = ax1.bar(x - width/2, solar_df['sim_v1'], width, label='v1 (제목)', alpha=0.8, color='#2196F3')
bars2 = ax1.bar(x + width/2, solar_df['sim_v2'], width, label='v2 (제목+Summary)', alpha=0.8, color='#FF5722')

ax1.set_xlabel('Golden Set')
ax1.set_ylabel('Cosine Similarity')
ax1.set_title('Solar Embedding', fontsize=14, fontweight='bold')
ax1.set_xticks(x)
ax1.set_xticklabels([f"{row['golden_id']}\n({row['difficulty']})" for _, row in solar_df.iterrows()])
ax1.legend()
ax1.set_ylim(0, 0.6)

# 향상률 표시
for i, (v1, v2) in enumerate(zip(solar_df['sim_v1'], solar_df['sim_v2'])):
    imp = (v2 - v1) / v1 * 100
    color = '#4CAF50' if imp > 0 else '#F44336'
    ax1.annotate(f'{imp:+.0f}%', xy=(i + width/2, v2 + 0.01), ha='center', fontsize=9, color=color, fontweight='bold')

# OpenAI Embedding
ax2 = axes[1]
bars1 = ax2.bar(x - width/2, openai_df['sim_v1'], width, label='v1 (제목)', alpha=0.8, color='#2196F3')
bars2 = ax2.bar(x + width/2, openai_df['sim_v2'], width, label='v2 (제목+Summary)', alpha=0.8, color='#FF5722')

ax2.set_xlabel('Golden Set')
ax2.set_ylabel('Cosine Similarity')
ax2.set_title('OpenAI text-embedding-3-small', fontsize=14, fontweight='bold')
ax2.set_xticks(x)
ax2.set_xticklabels([f"{row['golden_id']}\n({row['difficulty']})" for _, row in openai_df.iterrows()])
ax2.legend()
ax2.set_ylim(0, 0.6)

# 향상률 표시
for i, (v1, v2) in enumerate(zip(openai_df['sim_v1'], openai_df['sim_v2'])):
    imp = (v2 - v1) / v1 * 100
    color = '#4CAF50' if imp > 0 else '#F44336'
    ax2.annotate(f'{imp:+.0f}%', xy=(i + width/2, v2 + 0.01), ha='center', fontsize=9, color=color, fontweight='bold')

plt.tight_layout()
plt.show()
```

### 향상률 비교

```{python}
#| fig-cap: "난이도별 향상률"
#| fig-width: 8
#| fig-height: 5

# 향상률 데이터
improvements = pd.DataFrame({
    'Golden ID': solar_df['golden_id'],
    'Difficulty': solar_df['difficulty'],
    'Solar': solar_df['improvement'],
    'OpenAI': openai_df['improvement']
})

fig, ax = plt.subplots(figsize=(10, 5))

x = np.arange(len(improvements))
width = 0.35

# 난이도별 색상
difficulty_colors = {'Easy': '#81C784', 'Medium': '#FFD54F', 'Hard': '#E57373'}
edge_colors = [difficulty_colors[d] for d in improvements['Difficulty']]

bars1 = ax.bar(x - width/2, improvements['Solar'], width, label='Solar',
               color='#42A5F5', edgecolor=edge_colors, linewidth=3)
bars2 = ax.bar(x + width/2, improvements['OpenAI'], width, label='OpenAI',
               color='#AB47BC', edgecolor=edge_colors, linewidth=3)

ax.axhline(y=0, color='gray', linestyle='--', alpha=0.5)
ax.set_xlabel('Golden Set')
ax.set_ylabel('향상률 (%)')
ax.set_title('Summary 추가에 따른 유사도 향상률', fontsize=14, fontweight='bold')
ax.set_xticks(x)
ax.set_xticklabels([f"{row['Golden ID']}\n({row['Difficulty']})" for _, row in improvements.iterrows()])
ax.legend()

# 평균선
solar_avg = improvements['Solar'].mean()
openai_avg = improvements['OpenAI'].mean()
ax.axhline(y=solar_avg, color='#42A5F5', linestyle=':', alpha=0.7, label=f'Solar avg: {solar_avg:.1f}%')
ax.axhline(y=openai_avg, color='#AB47BC', linestyle=':', alpha=0.7, label=f'OpenAI avg: {openai_avg:.1f}%')

plt.tight_layout()
plt.show()
```

### 상세 수치

```{python}
# 결과 테이블
result_table = pd.DataFrame({
    'Golden ID': solar_df['golden_id'],
    '난이도': solar_df['difficulty'],
    'Solar v1': solar_df['sim_v1'].round(4),
    'Solar v2': solar_df['sim_v2'].round(4),
    'Solar 향상': solar_df['improvement'].apply(lambda x: f'{x:+.1f}%'),
    'OpenAI v1': openai_df['sim_v1'].round(4),
    'OpenAI v2': openai_df['sim_v2'].round(4),
    'OpenAI 향상': openai_df['improvement'].apply(lambda x: f'{x:+.1f}%'),
})

result_table
```

---

## 분석

### 핵심 발견

```{python}
#| fig-cap: "모델별 평균 향상률"
#| fig-width: 6
#| fig-height: 4

# 요약 통계
summary_data = {
    '구분': ['전체 평균', 'Easy 평균', 'Medium', 'Hard 평균'],
    'Solar': [
        solar_df['improvement'].mean(),
        solar_df[solar_df['difficulty'] == 'Easy']['improvement'].mean(),
        solar_df[solar_df['difficulty'] == 'Medium']['improvement'].mean(),
        solar_df[solar_df['difficulty'] == 'Hard']['improvement'].mean(),
    ],
    'OpenAI': [
        openai_df['improvement'].mean(),
        openai_df[openai_df['difficulty'] == 'Easy']['improvement'].mean(),
        openai_df[openai_df['difficulty'] == 'Medium']['improvement'].mean(),
        openai_df[openai_df['difficulty'] == 'Hard']['improvement'].mean(),
    ]
}

summary_df = pd.DataFrame(summary_data)

# 막대 그래프
fig, ax = plt.subplots(figsize=(8, 5))

x = np.arange(len(summary_df))
width = 0.35

bars1 = ax.bar(x - width/2, summary_df['Solar'], width, label='Solar', color='#42A5F5')
bars2 = ax.bar(x + width/2, summary_df['OpenAI'], width, label='OpenAI', color='#AB47BC')

ax.set_ylabel('향상률 (%)')
ax.set_title('난이도별 평균 향상률', fontsize=14, fontweight='bold')
ax.set_xticks(x)
ax.set_xticklabels(summary_df['구분'])
ax.legend()

# 값 표시
for bars in [bars1, bars2]:
    for bar in bars:
        height = bar.get_height()
        ax.annotate(f'{height:.1f}%',
                    xy=(bar.get_x() + bar.get_width() / 2, height),
                    xytext=(0, 3),
                    textcoords="offset points",
                    ha='center', va='bottom', fontsize=10)

plt.tight_layout()
plt.show()
```

::: {.callout-important}
## 핵심 결론

1. **Summary 추가 효과 확실** - 평균 14~29% 유사도 향상
2. **Hard 케이스에서 효과 극대화**
   - 약사법: OpenAI **+39.9%**
   - 국유재산특례제한법: Solar **+29.1%**
3. **OpenAI가 Summary 활용도 더 높음** - 29.4% vs 14.4%
:::

### 법안별 해석

| 법안 | 해석 |
|------|------|
| **golden_1** (탄소중립 기본법) | 기후위기-산업 연관성이 summary에서 드러남 |
| **golden_2** (중대재해 처벌법) | "공장", "안전관리체계" 등 산업 키워드 포함 |
| **golden_3** (개인정보 보호법) | 산업부와 직접 관련 적어 효과 미미 |
| **golden_4** (약사법) | "의약품 제조", "공장 설비" 등 제조업 관련 내용 |
| **golden_5** (국유재산특례제한법) | "신재생에너지", "에너지전환" 등 에너지 정책 키워드 |

---

## 결론 및 제언

### 결론

> **제목+제안이유 임베딩 전략이 Cross-Domain 감지에 효과적**임을 확인했습니다.
> 특히 **Hard 케이스**(제목만으로 관련성 파악이 어려운 법안)에서 효과가 두드러집니다.

### 제언

1. **프로덕션 적용 시 v2(제목+Summary) 전략 채택**
2. **OpenAI text-embedding-3-small 권장** (비용 대비 효과 우수)
3. **임계값(threshold) 조정 필요** - v2 기준 0.45 이상이면 관련 법안으로 분류 권장

---

## 부록: 실험 환경

- **테스트 일시**: 2026-01-16
- **모델**:
  - Solar Embedding (Upstage API)
  - text-embedding-3-small (OpenAI API)
- **데이터**:
  - 산업통상자원부 R&R (822자, 증강 버전)
  - Golden Set 5건 (제목 평균 20자, summary 평균 608자)
