# 작업일지 2026-01-19

## 완료 작업

### 1. 야간 배치 작업 실행 (전날 밤)
`run_overnight.py` 스크립트 실행:

| 작업 | 내용 | 결과 |
|------|------|------|
| 부처별 스캔 | 13개 부처 × 1,021건 | 완료 |
| 임계값 비교 | 6개 임계값 테스트 | 완료 |
| 소요 시간 | ~10분 (캐시 활용) | - |

### 2. 야간 배치 결과 분석

#### 부처별 감지율 (TOP 5)
| 순위 | 부처 | 감지율 | HIGH |
|------|------|--------|------|
| 1 | **행정안전부** | **75.2%** | 4 |
| 2 | 산업통상부 | 60.1% | 2 |
| 3 | 보건복지부 | 53.5% | 2 |
| 4 | 법무부 | 50.9% | 0 |
| 5 | 국방부 | 39.4% | 0 |

#### 임계값별 감지율 (산업통상부)
| 임계값 | 감지 법안 | 감지율 |
|--------|----------|--------|
| 0.40 | 889 | 87.1% |
| 0.44 | 685 | 67.1% |
| **0.45** | **614** | **60.1%** |
| 0.50 | 294 | 28.8% |

### 3. 분석 리포트 문서화

2가지 버전으로 작성:

| 파일 | 형식 | 특징 |
|------|------|------|
| `overnight-batch-analysis-v1.md` | Markdown | 텍스트 기반 |
| `overnight-batch-analysis-v1.qmd` | Quarto | 시각화 포함 (Python) |

**리포트 주요 내용:**
1. 부처별 감지 특성 분류 (범용형/중간형/특화형)
2. 임계값 최적화 분석
3. 전략 매트릭스 (부처 유형 × 임계값)
4. 권장사항 (단기/중기/장기)

## 핵심 인사이트

### 부처 유형 분류
- **🔴 범용형** (50%+): 행정안전부, 산업통상부, 보건복지부, 법무부
- **🟡 중간형** (20~50%): 국방부, 교육부, 해양수산부, 농림축산식품부
- **🟢 특화형** (20% 미만): 국토교통부, 문화체관부, 외교부

### 임계값 전략
- **범용형 부처**: 0.50+ 권장 (노이즈 방지)
- **중간형 부처**: 0.45 유지
- **특화형 부처**: 0.42~0.44 권장 (누락 방지)

## 산출물

```
projects/project-popcorn/
├── run_overnight.py                           # [NEW] 야간 배치 스크립트
├── output/overnight_batch/
│   ├── ministries/                            # 부처별 리포트
│   ├── thresholds/                            # 임계값별 결과
│   ├── ministry_scan_summary.json             # 부처별 요약
│   ├── threshold_comparison.json              # 임계값 비교
│   └── overnight_summary.md                   # 전체 요약
└── docs/
    ├── overnight-batch-analysis-v1.md         # [NEW] Markdown 리포트
    └── overnight-batch-analysis-v1.qmd        # [NEW] Quarto 리포트
```

### 4. Quarto 리포트 렌더링
- `quarto render` 실행 완료
- 한글 폰트 설정 (AppleGothic)
- 시각화 포함 HTML 리포트 생성

### 5. 문서 정리 및 구조화

docs 폴더 재구조화:
```
docs/
├── README.md          # 프로젝트 개요
├── ARCHITECTURE.md    # 시스템 아키텍처
├── QUICKSTART.md      # 빠른 시작 가이드
├── INDEX.md           # 문서 인덱스
├── OPERATIONS.md      # [NEW] 운영 가이드
├── archive/           # 과거 문서
├── analysis/          # 분석 리포트
└── plans/             # 설계 문서
```

---

## Phase 3: 운영 파이프라인 구축 (오후)

### 사용자 요구사항 (6가지)
1. **데이터 파이프라인 우선** - 연속적 데이터 흐름
2. **빠른 운영 진입** - 도메인 전문가 피드백 루프
3. **동적 임계값** - 부처별 맞춤 threshold
4. **키워드 가산점** - "탄소중립기본법 딜레마" 해결
5. **로컬 PC 서버** - 24시간 운영
6. **일배치 스케줄러** - launchd 활용

### Phase 3-1: 일일 수집 모듈
`src/ingest_daily.py` 구현:
- 어제 이후 제안된 법안 수집
- 일별 파일 저장 (`data/daily/bills_YYYY-MM-DD.json`)
- 마스터 데이터 병합 (중복 제거)

### Phase 3-2: 동적 스코어링 + 키워드 가산점

**config/ministry_config.yaml** (18개 부처 설정):
```yaml
ministries:
  산업통상부:
    threshold: 0.45
    type: 중간형
    keywords: [에너지, 탄소, 산업, 통상, 수출, ...]
    keyword_bonus: 0.03
  행정안전부:
    threshold: 0.52
    type: 범용형
  국토교통부:
    threshold: 0.42
    type: 특화형
```

**src/scorer_v2.py** 구현:
- 동적 임계값 시스템
- 키워드 가산점: `최종스코어 = CosineSim + min(매칭수 × bonus, 0.05)`
- Alert Level: CRITICAL(0.75+), HIGH(0.65+), MEDIUM(0.55+), LOW(threshold+)

**탄소중립기본법 딜레마 해결:**
- Before: 0.441 (임계값 0.45 미만 → 미감지)
- After: 0.441 + 0.03 = 0.471 (감지됨!)

### Phase 3-3: Teams 알림 모듈
`src/notifier.py` 구현:
- `TeamsNotifier` 클래스
- 일일 요약 알림 (`send_daily_summary`)
- 긴급 알림 (`send_alert`) - HIGH/CRITICAL용
- 에러 알림 (`send_error`)
- MessageCard 형식 (색상, 팩트, 마크다운)

### Phase 3-4: 일배치 통합 + 스케줄러

**run_daily.py** - 4단계 파이프라인:
1. 신규 법안 수집 (ingest_daily)
2. Cross-Domain 스캔 (radar + scorer_v2)
3. 리포트 생성 (reporter)
4. Teams 알림 (notifier)

CLI 옵션:
```bash
python run_daily.py                    # 기본 실행
python run_daily.py --ministry 국토교통부  # 특정 부처
python run_daily.py --since 2026-01-15    # 특정 날짜 이후
python run_daily.py --test               # 테스트 모드
```

**config/com.popcorn.radar.plist** - launchd 스케줄러:
- 매일 09:00 자동 실행
- 로그: `logs/launchd_stdout.log`, `logs/launchd_stderr.log`

### Phase 3 테스트 실행
```
[2026-01-19 13:30:03] Cross-Domain Radar 일배치 시작
[2026-01-19 13:30:03] [1/4] 수집 건너뜀 (skip_ingest)
[2026-01-19 13:30:03] [2/4] Cross-Domain 스캔
[2026-01-19 13:30:03]   → 부처: 산업통상부, 임계값: 0.45
[2026-01-19 13:30:03]   → 법안 로드: 1021건
[2026-01-19 13:30:03]   → 2026-01-18 이후 법안: 0건
[2026-01-19 13:30:03] 일배치 완료!
```
→ 파이프라인 정상 동작 확인 (어제 이후 신규 법안 없어서 0건)

---

## Phase 3 산출물

```
projects/project-popcorn/
├── src/
│   ├── ingest_daily.py      # [NEW] 일일 수집 모듈
│   ├── scorer_v2.py         # [NEW] 동적 스코어링
│   └── notifier.py          # [NEW] Teams 알림
├── config/
│   ├── ministry_config.yaml # [NEW] 부처별 설정 (18개)
│   └── com.popcorn.radar.plist  # [NEW] launchd 스케줄러
├── run_daily.py             # [NEW] 일배치 통합 스크립트
├── docs/
│   └── OPERATIONS.md        # [NEW] 운영 가이드
└── logs/                    # 로그 디렉토리
```

---

## 배포 준비 (오후)

### 회사 PC 배포용 파일 생성

```
projects/project-popcorn/
├── Dockerfile              # [NEW] Docker 이미지 빌드
├── docker-compose.yml      # [UPDATE] radar + scheduler 추가
├── Makefile                # [NEW] 편의 명령어
├── .dockerignore           # [NEW]
├── .env.example            # [UPDATE] 이메일 설정 추가
├── requirements-prod.txt   # [NEW] 운영용 의존성
│
├── deploy/
│   ├── setup-docker.sh     # [NEW] Docker 자동 설치
│   ├── setup-native.sh     # [NEW] Native Python 설치
│   └── setup-windows.bat   # [NEW] Windows 설치
│
└── docs/
    └── DEPLOYMENT.md       # [NEW] 배포 가이드
```

### 이메일 알림 모듈 추가

**src/notifier_email.py** 구현:
- HTML 형식 일일 요약 메일 (예쁜 표 스타일)
- HIGH/CRITICAL 즉시 알림
- 리포트 파일 첨부 지원
- 다중 수신자 지원

**run_daily.py 업데이트:**
- Teams + 이메일 동시 발송 지원

### 이메일 서비스 조사

Gmail 앱 비밀번호 발급 시도 → **실패** (신규 계정 보안 제한)

**2025-2026 이메일 발송 방법 비교:**

| 방법 | 무료 한도 | 설정 난이도 | 비고 |
|------|----------|------------|------|
| **Resend** | 월 3,000건 | 매우 쉬움 | API Key만 필요, 추천 |
| SendGrid | 일 100건 | 쉬움 | Twilio 운영 |
| AWS SES | 월 62,000건 | 중간 | AWS 계정 필요 |
| Gmail SMTP | 일 500건 | 복잡 | 앱 비밀번호 이슈 |
| Naver SMTP | 제한적 | 쉬움 | 국내 서비스 |

**결론:** Resend 사용 예정 (가입 후 API Key 발급만 하면 됨)

---

## 다음 할 일 (TODO)

1. [ ] **메일링 대상 확정** - 알림 받을 사람 리스트 (산업부 과장 등)
2. [ ] **Resend 가입 및 API Key 발급** - https://resend.com
3. [ ] **notifier_email.py Resend 버전으로 교체**
4. [ ] **회사 PC 배포** - 스케줄러 등록
5. [ ] **피드백 수집** - 도메인 전문가 검토

## 비고
- Phase 3 구현 완료
- 배포 준비 완료 (Docker + Native 스크립트)
- 이메일 알림: Resend API 사용 예정
- Gmail 앱 비밀번호: 신규 계정 보안 정책으로 발급 불가 (패스키 기본 설정)
- 슬립 방지: `caffeinate` 또는 `pmset -c sleep 0`

---

*Last updated: 2026-01-19*
